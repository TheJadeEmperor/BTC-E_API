<?php
//alert mysql ajax calls
$createAlert = 'include/ajax.php?action=create';
$readAlert = 'include/ajax.php?action=read';
$updateAlert = 'include/ajax.php?action=update';
$deleteAlert = 'include/ajax.php?action=delete';

//trade mysql jax calls
$createTrade = 'include/ajax.php?action=createTrade';
$readTrade = 'include/ajax.php?action=readTrade';
$updateTrade = 'include/ajax.php?action=updateTrade';
$deleteTrade = 'include/ajax.php?action=deleteTrade';

//page load ajax calls
$loadCronSendAlerts = 'load.php?page=cronSendAlerts&accessKey='.$accessKey;
$loadbtcTrades = 'load.php?page=btcTrades&accessKey='.$accessKey;
$loadPriceTable = 'load.php?page=priceTable&accessKey='.$accessKey;
$loadCronAutoTrade = 'load.php?page=cronAutoTrade&accessKey='.$accessKey;
$loadBalanceTable = 'load.php?page=balanceTable&accessKey='.$accessKey;
//$loadPoloBalance2 = 'load.php?page=poloBalance2&accessKey='.$accessKey;
$loadBtrexBalance = 'load.php?page=btrexBalance&accessKey='.$accessKey;

$loadBitmexPositions = 'load.php?page=bitmexPositions&accessKey='.$accessKey;
$loadBitmexPositions2 = 'load.php?page=bitmexPositions2&accessKey='.$accessKey;

$loadNotesAjax = 'include/ajax.php?action=updateNotes';
$loadNotes = 'load.php?page=notes&accessKey='.$accessKey;
?>
<script>
	
	function updateAlert(id) {
		$.ajax({ //Process the form using $.ajax()
			type        : 'POST', //Method type
			url         : '<?=$updateAlert?>', //Your form processing file url
			data        : $('#conditionTable').serialize(), 
			success     : function(msg) {
				console.log($('#conditionTable').serialize());
				console.log(msg);
				reloadAlertsTable();				
			}
		});
		event.preventDefault(); //Prevent the default submit      
	}
	
	function updateTrade(id) {
		console.log($('#tradeTable').serialize() );
		$.ajax({ //Process the form using $.ajax()
			type        : 'POST', //Method type
			url         : '<?=$updateTrade?>', //Your form processing file url
			data        : $('#tradeTable').serialize(), 
			success     : function(msg) {
				console.log(msg);
				$('#btcTrades').load('<?=$loadbtcTrades?>');						
			}
		});
		event.preventDefault(); //Prevent the default submit      
	}
	
	function fillFormAlert(id) {

		var link = "<?=$readAlert?>&id="+id;
		console.log( link );
		
		$.getJSON("<?=$readAlert?>&id="+id, function( data ) {
		
			$.each( data, function( key, val ) {
				if(data.hasOwnProperty(key))
					$('input[name='+key+']').val(val);

				if(key == 'currency') {						
					$('select[name="currency"]').find('option:contains("'+val+'")').attr("selected",true);	
				}
				
				if(key == 'on_condition') {					
					$('select[name="on_condition"]').find('option:contains("'+val+'")').attr("selected",true);	
				}
			
				if(key == 'unit') {
					$('select[name="unit"]').find('option:contains("'+val+'")').attr("selected",true);	
				}
				
				if(key == 'exchange' || key == 'sent') {
					$('select[name="'+key+'"]').find('option:contains("'+val+'")').attr("selected",true);	
				}
            });

		});
	}
	
	function fillFormTrade(id) {

		$.getJSON("<?=$readTrade?>&trade_id="+id+"", function( data ) {
			console.log('fillFormTrade: '+data);
			$.each( data, function( key, val ) {
					if(data.hasOwnProperty(key))
						$('input[name='+key+']').val(val);

					if(key == 'id') {
						$('input[name=trade_id]').val(val);
					}
					
					//select the values for drop down menus
					if(key == 'trade_currency' || key == 'trade_condition' || key == 'trade_exchange' || key == 'trade_action' || key == 'trade_unit') {
						$('select[name="'+key+'"]').find('option:contains("'+val+'")').attr("selected",true);		
					}
				});
			});
	}
    
    function deleteAlert(id) {
	
		var confirmDelete = confirm("Are you sure you wish to delete alert "+id+"?");
		
		if(confirmDelete == true) {
			$.ajax({
				type: "GET",
				url: "<?=$deleteAlert?>&id="+id,
				success: function() {
					reloadAlertsTable();
                    //$('#btcAlerts').load('<?=$loadCronSendAlerts?>');
                }
			})
			$("#conditionTable").dialog("close");
			event.preventDefault(); 
			return false;
		}
		else {
			return false;
		}
    }
	    
	function deleteTrade(id) {
	
		var confirmDelete = confirm("Are you sure you wish to delete trade "+id+"?");
		
		if(confirmDelete == true) {
			 $.ajax({
                type: "GET",
                url: "<?=$deleteTrade?>&trade_id="+id,
                success: function() {
					reloadTradesTable();
				
                }
			})
			$("#tradeTable").dialog("close");	
			event.preventDefault(); 
			return false;
		}
		else {
			return false;
		}
    }
	
    function createAlert() {
		$.ajax({
			type: "POST",
			url: "<?=$createAlert?>",
			data: $('#conditionTable').serialize(),
			success: function(msg) {
				console.log(msg);
				reloadAlertsTable();				
			}
		});
    }
	
	function createTrade() {
		$.ajax({
			type: "POST",
			url: "<?=$createTrade?>",
			data: $('#tradeTable').serialize(),
			success: function(msg) {
				console.log(msg);				
				$('#btcTrades').load('<?=$loadbtcTrades?>');						
			}
		});
    }
	
	function updateAlertDialog(id) {
	
		$("select[name=currency]").remove(); //remove  acct select menu
		$("#currencyDiv").html('<?=$currencyDropDown?>');	//re-construct the acct menu
			
		$("select[name=on_condition]").remove();	//remove on_condition select menu
		$("#conditionDiv").html('<?=$conditionDropDown?>');	//re-construct the on_condition men
		
		$("select[name=unit]").remove();	//remove unit select menu
		$("#unitDiv").html('<?=$unitDropDown?>');	//re-construct the unit menu
		
		$("select[name=exchange]").remove();	//remove exchange menu
		$("#exchangeDiv").html('<?=$exchangeDropDown?>');	//re-construct the exchange men

		$('select[name=sent]').remove();
		$('#sentDiv').html('<?=$sentDropDown?>');

		$('button[id=deleteAlert]').remove();
		$('#alertDeleteDiv').html('<?=$alertDeleteDiv?>');
		
			
		fillFormAlert(id);
	
		$( "#deleteAlert" ).click(function() {
			return deleteAlert(id);
		});
		
		$("#conditionTable").dialog({
			modal: true,
			width: 790,
			position: 'top',
			show: {
				effect: "explode",
				duration: 500
			},
			hide: {
				effect: "explode",
				duration: 500
			},
			buttons: {
				Save: function () {
					updateAlert(id);
					$( this ).dialog( "close" );
				},
				Cancel: function() {
					reloadAlertsTable();
					$( this ).dialog( "close" );				
				},                        
			}
		});	
	}
	
	function updateTradeDialog(id) {

		$("select[name=trade_currency]").remove(); //remove  acct select menu
		$("#tradeCurrencyDiv").html('<?=$tradeCurrencyDropDown?>');	//re-construct the acct menu
			
		$("select[name=trade_condition]").remove();	//remove on_condition select menu
		$("#tradeConditionDiv").html('<?=$tradeConditionDropDown?>');	//re-construct the on_condition menu
		
		$("select[name=trade_exchange]").remove();	//remove exchange menu
		$("#tradeExchangeDiv").html('<?=$tradeExchangeDropDown?>');	//re-construct the exchange menu

		$("select[name=trade_action]").remove();	//remove action menu
		$("#tradeActionDiv").html('<?=$tradeActionDropDown?>');	//re-construct the action menu

		$("select[name=trade_unit]").remove();	//remove action menu
		$("#tradeUnitDiv").html('<?=$tradeUnitDropDown?>');	//re-construct the unit menu

		$("#deleteTrade").remove(); //remove delete button - prevents the bug of deleting multiple records 
		$("#deleteTradeButtonDiv").html('<button id="deleteTrade" class="btn btn-danger">Delete</button>'); //re-construct delete button 
		
		fillFormTrade(id);
	
		$( "#deleteTrade" ).click(function() {
			return deleteTrade(id);
		});
		
		$("#tradeTable").dialog({
			modal: true,
			width: 790,
			position: 'top',
			show: {
				effect: "explode",
				duration: 500
			},
			hide: {
				effect: "explode",
				duration: 500
			},
			buttons: {
				Save: function () {
					updateTrade(id);
					$( this ).dialog( "close" );
				},
				Cancel: function() {						
					$( this ).dialog( "close" );	
					$('#btcTrades').load('<?=$loadbtcTrades?>');						
				},                        
			}
		});	
	}
	
	function reloadNotes(){
		$('#notesDiv').load('<?=$loadNotes?>');		
	}
 
 /*
	function reloadBalanceTable(){
	
		$('#balanceTable').load('<?=$loadBalanceTable?>');		
		
		$('#balanceTable').html('<img src="include/images/load.gif" id="loading" />')

		$(window).bind('load', function() {
            $('#balanceTable #loading').hide();
            $('#balanceTable').load('<?=$loadBalanceTable?>');		
            $('#balanceTable').fadeIn('slow');
        });
	
		//$('#balanceTable').load('<?=$loadBalanceTable?>');		
	}
	*/
	
	/*
	function reloadBtrexBalance(){
		$('#btrexBalance').load('<?=$loadBtrexBalance?>');		
	}
	*/
	
	function reloadTable (divName) {
		if(divName == '#priceTable') {
			loadPage = '<?=$loadPriceTable?>';
		}
		else if(divName == '#balanceTable') {
			loadPage = '<?=$loadBalanceTable?>';
		}
		else if(divName == '#bitmexPositions') {
			loadPage = '<?=$loadBitmexPositions?>';
		}
		else if(divName == '#bitmexPositions2') {
			loadPage = '<?=$loadBitmexPositions2?>';
		}
		else if(divName == '#btrexBalance') {
			loadPage = '<?=$loadBalanceTable?>';
		}
		
		console.log(divName);
	
		$(divName).load(loadPage);		
		
		//$(divName).hide(); 
		$(divName).html('<img src="include/images/load.gif" id="loading" />')

		$(window).bind('load', function() {
            $(divName+' #loading').hide();
            $(divName).load(loadPage);		
            $(divName).fadeIn('slow');
        });
	}
	
	function reloadPriceTable() {
		$('#priceTable').load('<?=$loadPriceTable?>');		
		
		//$('#priceTable').hide(); 
		$('#priceTable').html('<img src="include/images/load.gif" id="loading" />')

		$(window).bind('load', function() {
            $('#priceTable #loading').hide();
            $('#priceTable').load('<?=$loadPriceTable?>');		
            $('#priceTable').fadeIn('slow');
        });
	}
		
	function reloadAlertsTable() {
		$('#cronSendAlerts').load('<?=$loadCronSendAlerts?>');		
		
		//$('#cronSendAlerts').hide(); 
		$('#cronSendAlerts').html('<img src="include/images/load.gif" id="loading" />')

		$(window).bind('load', function() {
            $('#cronSendAlerts #loading').hide();
            $('#cronSendAlerts').load('<?=$loadCronSendAlerts?>');		
            $('#cronSendAlerts').fadeIn('slow');
        });
	}
	
	function reloadTradesTable() {
		$('#btcTrades').load('<?=$loadbtcTrades?>');
		
		$('#btcTrades').html('<img src="include/images/load.gif" id="loading" />')
		
		$(window).bind('load', function() {
			$('#btcTrades #loading').hide();
			$('#btcTrades').load('<?=$loadbtcTrades?>');		
			$('#btcTrades').fadeIn('slow');
		});
	}
		
	function cronAutoTrade() {
	
		$('#cronAutoTrade').load('<?=$loadCronAutoTrade?>');
		
		$('#cronAutoTrade').html('<img src="include/images/load.gif" id="loading" />')
		
		$(window).bind('load', function() {
			$('#cronAutoTrade #loading').hide();
			$('#cronAutoTrade').load('<?=$loadCronAutoTrade?>');		
			$('#cronAutoTrade').fadeIn('slow');
		});
	}
	

    $(document).ready(function () {
		
		//hide pop up forms			
		$("#conditionTable").hide();
		$("#tradeTable").hide();		
		$("#accountBalance").hide();		
		
		$("#until_date").datepicker();
							
		$(".createButton").click(function() {

			console.log('createbutton');
			$("#conditionTable").dialog({
				modal: true,
				width: 790,
				position: 'top',
				show: {
					effect: "explode",
					duration: 500
				},
				hide: {
					effect: "explode",
					duration: 500
				},
				buttons: {
					Save: function() {
						createAlert();
						$(this).dialog("close");
					},
					Cancel: function() {
						$(this).dialog("close");
					}
				}
			})
		});
		
		$(".tradeButton").click(function() {
			$("#tradeTable").dialog({
				modal: true,
				width: 790,
				position: 'top',
				show: {
					effect: "explode",
					duration: 500
				},
				hide: {
					effect: "explode",
					duration: 500
				},
				buttons: {
					Save: function() {
						createTrade();
						$(this).dialog("close");
					},
					Cancel: function() {
						$(this).dialog("close");
					}
				}
			})
		});	
	
	
		
		$.fn.counter = function (num) {
			var i = 1;
			self = $(this).html(i);	//console.log(self);
			
			var interval = setInterval(function () {
			
				self.html(++i);
				if (i >= num) {
							
					//clearInterval(interval);
					i = 0;
					reloadTable('#priceTable');
					cronAutoTrade();
				} 
			}, 1000);
		};

		$('#counter').counter(60);
	
		
		reloadNotes(); 
		
		reloadPriceTable();
		
		reloadAlertsTable();
		
		reloadTradesTable();

		reloadTable('#balanceTable');
		
		//reloadBalanceTable();
		
		cronAutoTrade();
		
		reloadTable('#bitmexPositions');
			
		reloadTable('#bitmexPositions2');
		
		reloadTable('#btrexBalance');
		
		//reloadBtrexBalance();
		

    });
</script>